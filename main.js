(()=>{"use strict";var e=document.querySelector(".page");function t(t){var r=function(e){return function(e,t){e&&e.key&&"escape"===e.key.toLowerCase()&&n(t)}(e,t)};e.addEventListener("keydown",r),t.removeEventListenerRef=r,t.classList.add("popup_is-opened")}function n(t){t.classList.contains("popup_is-opened")&&(t.classList.remove("popup_is-opened"),e.removeEventListener("keydown",t.removeEventListenerRef))}var r=function(e){return!(!e.ok||!e.status||200!==e.status)},o={baseUrl:"https://nomoreparties.co/v1/wff-cohort-23",headers:{authorization:"40c6a7fb-a996-4c45-aa96-4765b718300e","Content-Type":"application/json"}},a=document.querySelector("#card-template").content,i=function(e,t,n,r,o){var i=a.querySelector(".places__item").cloneNode(!0);a.addEventListener("click",(function(e){return t(e,i)}));var c=i.querySelector(".card__image"),s=i.querySelector(".card__delete-button"),u=i.querySelector(".card__title"),l=i.querySelector(".card__like-button"),d=i.querySelector(".card__like-count");return console.log("cardCreate card: ",e," ",e.owner&&e.owner._id&&o._id&&e.owner._id===o._id),e.owner&&e.owner._id&&o._id&&e.owner._id===o._id&&s.classList.remove("card__delete-button-hidden"),e.likes.some((function(e){return e._id===o._id}))&&l.classList.add("card__like-button_is-active"),s.addEventListener("click",(function(n){return t(n,i,e)})),l.addEventListener("click",(function(t){return n(t,i,e)})),c.src=e.link||"",c.alt="Mesto "+e.name||0,u.textContent=e.name||"",d.textContent=e.likes&&e.likes.length?e.likes.length:0,c.addEventListener("click",(function(e){return r(e,c)})),i},c=function(e,t,n){var a;e.stopPropagation(),(a=n.id,fetch("".concat(o.baseUrl,"/cards/").concat(a),{method:"DELETE",headers:o.headers}).then((function(e){if(r(e))return e.json();Promise.reject("Возникла ошибка!")}))).then((function(e){e&&e.message&&e.message.toLowerCase().includes("пост")&&t.remove()})).catch((function(e){return console.log(e)}))},s=function(e,t,n){e.stopPropagation();var a,i=t.querySelector(".card__like-button"),c=t.querySelector(".card__like-count");Array.from(i.classList).some((function(e){return"card__like-button_is-active"===e}))?(a=n.id,fetch("".concat(o.baseUrl,"/cards/likes/").concat(a),{method:"DELETE",headers:o.headers}).then((function(e){if(r(e))return e.json();Promise.reject("Возникла ошибка!")}))).then((function(e){c.textContent=e&&e.likes&&Array.isArray(e.likes)?e.likes.length:0,i.classList.toggle("card__like-button_is-active")})).catch((function(e){return console.log(e)})):function(e){return fetch("".concat(o.baseUrl,"/cards/likes/").concat(e),{method:"PUT",headers:o.headers}).then((function(e){if(r(e))return e.json();Promise.reject("Возникла ошибка!")}))}(n.id).then((function(e){c.textContent=e&&e.likes&&Array.isArray(e.likes)?e.likes.length:0,i.classList.toggle("card__like-button_is-active")})).catch((function(e){return console.log(e)}))},u=function(e,t){var n=Array.from(e.querySelectorAll(t.inputSelector)),r=e.querySelector(t.submitButtonSelector);n.forEach((function(n){var r=e.querySelector(".".concat(n.id,"-error"));r.textContent="",r.classList.remove(t.errorClass),n.classList.remove(t.inputErrorClass)})),l(r,n,t),console.log("clearValidation submitButtonStatus: ",[r]),console.log("clearValidation submitButtonStatus: ",[n])},l=function(e,t,n){t.map((function(e){return f(e)})).some((function(e){return!e}))?(e.classList.add(n.inactiveButtonClass),e.disabled=!0):(e.classList.remove(n.inactiveButtonClass),e.disabled=!1)},d=function(e,t,n){t.forEach((function(t){var r=e.querySelector(".".concat(t.id,"-error"));t.setCustomValidity(""),f(t)?function(e,t,n){e.classList.remove(n.inputErrorClass),t.classList.remove(n.errorClass),t.textContent="",e.setCustomValidity("")}(t,r,n):function(e,t,n){e.classList.add(n.inputErrorClass),e.validity.patternMismatch&&"text"===e.type?e.setCustomValidity(e.dataset.errorMessage):e.setCustomValidity(""),t.textContent=e.validationMessage,t.classList.add(n.errorClass)}(t,r,n)}))},f=function(e){return e.validity.valid},p={formSelector:".popup__form",inputSelector:".popup__input",submitButtonSelector:".popup__button",inactiveButtonClass:"popup__button_disabled",inputErrorClass:"popup__input_type_error",errorClass:"popup__error_visible"},m=document.querySelector(".profile__edit-button"),_=document.querySelector(".popup_type_edit"),v=_.querySelector(p.formSelector),y=document.querySelector(".content"),h=y.querySelector(".profile__title"),S=y.querySelector(".profile__description"),k=document.querySelector(".popup_type_avatar"),b=y.querySelector(".profile__image"),L=y.querySelector(".profile__image-change-avatar"),C=document.forms["new-avatar"],q=k.querySelector(".popup__close"),g=document.forms["edit-profile"],E=_.querySelector(".popup__close"),x=document.querySelector(".profile__add-button"),D=document.querySelector(".popup_type_new-card"),w=D.querySelector(p.formSelector),P=document.forms["new-place"],j=D.querySelector(".popup__close"),A=document.querySelector(".popup_type_image"),B=A.querySelector(".popup__close"),T=document.querySelector(".places__list"),U=document.querySelector(".places__list"),V=document.querySelector(".popup_type_image"),M=V.querySelector(".popup__image"),N=V.querySelector(".popup__caption");Promise.all([fetch("".concat(o.baseUrl,"/cards"),{headers:o.headers}).then((function(e){if(r(e))return e.json();Promise.reject("Возникла ошибка!")})),fetch("".concat(o.baseUrl,"/users/me"),{headers:o.headers}).then((function(e){if(r(e))return e.json();Promise.reject("Возникла ошибка!")}))]).then((function(e){var a={profileData:e[1]||{},cardsData:e[0]||{}},f=function(e){return e&&e.cardsData&&Array.isArray(e.cardsData)?e.cardsData.map((function(e){return{id:e._id||"",name:e.name||"",link:e.link||"",likes:e.likes||[],owner:e.owner||{}}})):[]}(a),y=function(e,n){e.stopPropagation(),M.src=n.src||"",M.alt=n.alt||"",N.textContent=e.target&&e.target.offsetParent&&e.target.offsetParent.innerText?e.target.offsetParent.innerText:"",t(V)};f.forEach((function(e){U.append(i(e,c,s,y,a.profileData))})),h.textContent=a&&a.profileData&&a.profileData.name?a.profileData.name:"",S.textContent=a&&a.profileData&&a.profileData.about?a.profileData.about:"",b.src=a&&a.profileData&&a.profileData.avatar?a.profileData.avatar:"",C["avatar-link"].value=a&&a.profileData&&a.profileData.avatar?a.profileData.avatar:"";var O=function(e,t){e.target===t&&n(t)};P.addEventListener("submit",(function(e){return function(e,t,l,d){e.preventDefault();var f,m,_=t.querySelector(p.submitButtonSelector);_.textContent="Сохранение...",_.disabled=!0,(f=l["place-name"].value,m=l.link.value,fetch("".concat(o.baseUrl,"/cards"),{method:"POST",headers:o.headers,body:JSON.stringify({name:f,link:m})}).then((function(e){if(r(e))return e.json()}))).then((function(e){var n={id:e._id||"",name:e.name||"",link:e.link||"",likes:e.likes||[],owner:e.owner||{}},r=i(n,c,s,y,a.profileData);d.prepend(r),l.reset(),_.textContent="Сохранить",_.disabled=!0,u(t,p)})).catch((function(e){return console.log(e)})).finally((function(){_.textContent="Сохранить",n(t)}))}(e,D,P,U)})),g.addEventListener("submit",(function(e){return function(e,t,a){e.preventDefault();var i,c,s=t.querySelector(p.submitButtonSelector);s.textContent="Сохранение...",s.disabled=!0,(i=a.name.value,c=a.description.value,fetch("".concat(o.baseUrl,"/users/me"),{method:"PATCH",headers:{authorization:"40c6a7fb-a996-4c45-aa96-4765b718300e","Content-Type":"application/json"},body:JSON.stringify({name:i,about:c})}).then((function(e){if(r(e))return e.json();Promise.reject("Возникла ошибка!")}))).then((function(e){h.textContent=e.name,S.textContent=e.about,s.disabled=!0,u(t,p)})).catch((function(e){return console.log(e)})).finally((function(){n(t),s.textContent="Сохранить"}))}(e,_,g)})),C.addEventListener("submit",(function(e){return function(e,t,a){e.preventDefault();var i,c=a.querySelector(p.submitButtonSelector);c.textContent="Сохранение...",c.disabled=!0,(i=t,fetch("".concat(o.baseUrl,"/users/me/avatar"),{method:"PATCH",headers:o.headers,body:JSON.stringify({avatar:i["avatar-link"].value||""})}).then((function(e){if(r(e))return e.json();Promise.reject("Возникла ошибка!")}))).then((function(e){e&&e.avatar&&(b.src=e.avatar,c.textContent="Сохранить",c.disabled=!0),t.reset(),u(t,p)})).catch((function(e){return console.log(e)})).finally((function(){c.textContent="Сохранить",n(a)}))}(e,C,k)})),m.addEventListener("click",(function(){t(_),g.name.value=h.textContent,g.description.value=S.textContent,u(v,p)})),E.addEventListener("click",(function(){n(_),u(v,p)})),_.addEventListener("click",(function(e){return O(e,_)})),b.addEventListener("click",(function(){t(k),C["avatar-link"].value=b.src,u(C,p)})),L.addEventListener("click",(function(){t(k),u(C,p)})),q.addEventListener("click",(function(){n(k),u(C,p)})),k.addEventListener("click",(function(e){return O(e,k)})),x.addEventListener("click",(function(){t(D),u(w,p)})),j.addEventListener("click",(function(){n(D)})),D.addEventListener("click",(function(e){return O(e,D)})),T.addEventListener("click",(function(){return t(A)})),B.addEventListener("click",(function(){return n(A)})),A.addEventListener("click",(function(e){return O(e,A)})),function(e){Array.from(document.querySelectorAll(e.formSelector)).forEach((function(t){return function(e,t){var n=Array.from(e.querySelectorAll(t.inputSelector)),r=e.querySelector(t.submitButtonSelector);l(r,n,t),d(e,n,t),n.forEach((function(o){o.addEventListener("input",(function(){return function(e,t,n,r){l(n,t,r),d(e,t,r)}(e,n,r,t)}))}))}(t,e)}))}(p)})).catch((function(e){return console.log(e)}))})();